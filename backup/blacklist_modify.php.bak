<?
	include "authenticate.php";
	include "config.inc.php";
	$access_level = access_level($username);
	$who = $username;
?>
	
<title>DHCP Manager</title>
<center>
<font color=0000ff>
<h1>DHCP Manager - MAC Blacklist</h1>
</font>
<? include "links.inc"; ?>
<br>

<? 
	include "db.inc.php";
	$id_link = mysql_pconnect($db_hostname, $db_username, $db_password);

	if (strcmp($action, "modify") == 0){

                // make sure it's an administrator
                include "admin_check.inc.php";

                // make sure mac is in right format
                check_mac_format($mac);

                // make sure computername only contains valid chars
                check_computername_format($username_db);

		$str_sql = "UPDATE $db_tablename_ip set username='$username_db', clientname='$clientname', mac='$mac', notes='$notes' WHERE username = '$username_db_old' AND mac = '$mac_db_old'";

		// print "Query: *$str_sql*<br>\n";
	        $result = mysql_db_query($db_name, $str_sql, $id_link);

	       	if (! $result){
       		        print "Failed to submit!<br>\n";
        		include "$footer";
              		exit;	
       		}	

                $datetime = date("Y-m-d H:i:s");
                $ip_from = $REMOTE_ADDR;

                $changes = "<b>MAC: Modify Blacklisted For ** $username_db **</b><br>\n";

                if (strcmp("$username_db_old", "$username_db") != 0){
                        $changes .= "Computer Name: $username_db_old => $username_db.<br>";
                }

                if (strcmp("$clientname_db_old", "$clientname") != 0){
                        $changes .= "Client Name: $clientname_db_old => $clientname.<br>";
                }

                if (strcmp("$mac_db_old", "$mac") != 0){
                        $changes .= "MAC: $mac_db_old => $mac.<br>";
                }

                if (strcmp("$notes_db_old", "$notes") != 0){
                        $changes .= "Notes: $notes_db_old => $notes.<br>";
                }

                $str_sql = "INSERT INTO $db_tablename_logs (who, ip, category, changes, datetime) VALUES ('$who', '$ip_from', 'mac', '$changes', '$datetime')";
                // print "Changes: *$changes*<br>\n";

                $result = mysql_db_query($db_name, $str_sql, $id_link);

                if (! $result){
                        print "Failed to submit log!<br>\n";
                        include "$footer";
                        exit;
                }

		print "<center>\n";
		print "<font color=ff0000>\n";
		print "<h3>MAC Record Updated!</h3>\n";
                print "<b><i><small>(Will Take Effect In About 1 Minute)</small></i></b>\n";
		print "</font>\n";
		print "</center>\n";

		mark_export();

	}
	
	else{

		$str_sql = "SELECT * FROM $db_tablename_ip WHERE username='$username_db'AND mac='$mac'";

	        $result = mysql_db_query($db_name, $str_sql, $id_link);
	       	if (! $result){
       		        print "Failed to submit!<br>\n";
        		include "$footer";
              		exit;	
       		}	

	        $row = mysql_fetch_object($result);

		print "<center>\n";
		print "<table width=35% border=4 cellpadding=2 cellspacing=2>\n";

                print "<form action=blacklist_modify.php>\n";
                print "<input type=hidden name=action value=modify>\n";
                print "<input type=hidden name=username value=$username>\n";
                print "<input type=hidden name=auth_string value=$auth_string>\n";
                print "<input type=hidden name=username_db_old value=$username_db>\n";
                print "<input type=hidden name=mac_db_old value=$mac>\n";
		print "<input type=hidden name=clientname_db_old value=\"$row->clientname\">\n";
		print "<input type=hidden name=notes_db_old value=\"$row->notes\">\n";

		print "<tr><td><b>Computer Name:</b></td><td><input type=text name=username_db value=\"$row->username\"</td></tr>\n";
		print "<tr><td><b>Client Name:</b></td><td><input type=text name=clientname value=\"$row->clientname\"</td></tr>\n";
		print "<tr><td><b>MAC:</b></td><td><input type=text name=mac value=\"$row->mac\"</td></tr>\n";
		print "<tr><td><b>Notes:</b></td><td><textarea name=notes cols=30 rows=4>$row->notes</textarea></td></tr>\n";
		print "<tr><td colspan=2 align=center><input type=submit value=Modify></td></tr>\n";

                print "</form>\n";
		print "</td></tr>\n";
		
		print "</table>\n";
		print "</center>\n";
		print "<br>\n";

	}

	include "$footer";

?>
