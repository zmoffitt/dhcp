<?
	include "authenticate.php";
	include "config.inc.php";
	$access_level = access_level($username);
	$who = $username;
?>
	
<title>DHCP Manager</title>
<body onload="changeScreenSize(500,300)">
<center>
<font color=0000ff>
<h1>DHCP Manager - MAC Management</h1>
</font>

<br>

<? 
	if (strcmp($action, "add") == 0){

                for (reset($dhcp_partners); $key = key($dhcp_partners); next($dhcp_partners)){
			$tmp = "\$partner_$key";
			eval("if ($tmp == 1){\$to_replicate = 1;}else{\$to_replicate = 0;}");
			print "$tmp = $to_replicate<br>\n";

		}

		
		if (! $username_db || ! $mac){
			print "<center><font color=ff0000>\n";
			print "<b>Computer Name and MAC are required!</b>\n";
			print "</font></center>\n";
			include "$footer";
			exit;
		}

                // make sure it's an administrator
		include "admin_check.inc.php";

                // make sure mac is in right format
                check_mac_format($mac);

                // make sure mac does not already exist in the database
                mac_exist($mac);

                // make sure computername only contains valid chars
                check_computername_format($username_db);

		include "db.inc.php";
       		$id_link = mysql_pconnect($db_hostname, $db_username, $db_password);
		$str_sql = "INSERT INTO $db_tablename_ip (ip, ip_type, mac, username, clientname, lease, notes) VALUES ('', 'registered', '$mac', '$username_db', '$clientname', 0, '$notes')";

		// print "Query: *$str_sql*<br>\n";

	        $result = mysql_db_query($db_name, $str_sql, $id_link);

	       	if (! $result){
       		        print "Failed to submit!<br>\n";
        		include "$footer";
               		exit;	
       		}	

                $datetime = date("Y-m-d H:i:s");
                $ip_from = $REMOTE_ADDR;

		$changes = "<b>MAC: Add Registered</b><br>\n";
		$changes .= "Computer Name: $username_db.<br>\n";
		$changes .= "Client Name: $clientname.<br>\n";
		$changes .= "MAC: $mac.<br>\n";
		$changes .= "Notes: $notes.<br>\n";

                $str_sql = "INSERT INTO $db_tablename_logs (who, ip, category, changes, datetime) VALUES ('$who', '$ip_from', 'mac', '$changes', '$datetime')";
		// print "Changes: *$changes*<br>\n";

		$result = mysql_db_query($db_name, $str_sql, $id_link);

		if (! $result){
			print "Failed to submit log!<br>\n";
			include "$footer";
			exit;
		}

		print "<center>\n";
		print "<font color=ff0000>\n";
		print "<b>MAC ($mac) added for <u>$username_db</u></b><br>\n";
                print "<b><i><small>(Will Take Effect In About 1 Minute)</small></i></b>\n";
		print "</font>\n";
		print "</center><br>\n";

                mark_export();

                // reset variables
                $username_db = "";
                $mac = "";

	}		

?>

<center>
<table border=2 cellspacing=2 cellpadding=2 width=50%>

<form METHOD=POST action=mac_add.php>
<input type=hidden name=action value=add>
<input type=hidden name=username value=<? echo "$username"; ?>>
<input type=hidden name=auth_string value=<? echo "$auth_string"; ?>>

<tr>
<td bgcolor=dddddd align=center colspan=2>
<font color=ff0000><b>Register a MAC</b></font>
</td>
</tr>

<tr>
<td><b>Computer Name:</b></td>
<td><input type=text name=username_db value="<? echo $username_db; ?>"></td>
</tr>

<td><b>Client Name:</b></td>
<td><input type=text name=clientname></td>
</tr>

<td><b>MAC:</b></td>
<td><input type=text name=mac value="<? echo $mac; ?>"></td>

</tr>

<td><b>Notes:</b></td>
<td><textarea name=notes cols=30 rows=4></textarea></td>
</tr>

<?
	if ($dhcp_replicate == 1){

		print "<tr>\n";
		print "<td><b>Also Update: <font color=ff0000>(Not Working Yet)</font></b></td>";
		print "<td>\n";

		for (reset($dhcp_partners); $key = key($dhcp_partners); next($dhcp_partners)){
			print "<input type=checkbox name=partner_$key value=1><b>" . ucfirst($key) . "</b>\n";
		}

		print "</td></tr>\n";

	}

?>

<tr><td align=center colspan=2>
<input type=submit name=selection value="Register MAC">
</td></tr>

</form>
</tr>
</table>
</center>
<br>

<?
	include "$footer";
?>

</body>
